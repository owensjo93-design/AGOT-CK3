agot_add_birthplace_bastard_nickname_effect = {
	if = {
		limit = {
			faith = {
				NOT = { has_doctrine_parameter = bastards_none }
			}
			NOR = {
				has_inactive_trait = surname_flowers
				has_inactive_trait = surname_hill
				has_inactive_trait = surname_pyke
				has_inactive_trait = surname_rivers
				has_inactive_trait = surname_sand
				has_inactive_trait = surname_snow
				has_inactive_trait = surname_stone
				has_inactive_trait = surname_storm
				has_inactive_trait = surname_waters
			}
			has_trait = bastard
		}
		if = {
			limit = { $BIRTHPLACE$ = { geographical_region = world_westeros_dorne } }
			custom_description = {
				text = agot_gain_surname_sand_effect
				object = this
				make_trait_inactive = surname_sand
			}
		}
		else_if = {
			limit = { $BIRTHPLACE$ = { geographical_region = world_westeros_the_iron_islands } }
			custom_description = {
				text = agot_gain_surname_pyke_effect
				object = this
				make_trait_inactive = surname_pyke
			}
		}
		else_if = {
			limit = { $BIRTHPLACE$ = { geographical_region = world_westeros_the_north } }
			custom_description = {
				text = agot_gain_surname_snow_effect
				object = this
				make_trait_inactive = surname_snow
			}
		}
		else_if = {
			limit = { $BIRTHPLACE$ = { geographical_region = world_westeros_the_reach } }
			custom_description = {
				text = agot_gain_surname_flowers_effect
				object = this
				make_trait_inactive = surname_flowers
			}
		}
		else_if = {
			limit = { $BIRTHPLACE$ = { geographical_region = world_westeros_the_riverlands } }
			custom_description = {
				text = agot_gain_surname_rivers_effect
				object = this
				make_trait_inactive = surname_rivers
			}
		}
		else_if = {
			limit = { $BIRTHPLACE$ = { geographical_region = world_westeros_the_stormlands } }
			custom_description = {
				text = agot_gain_surname_storm_effect
				object = this
				make_trait_inactive = surname_storm
			}
		}
		else_if = {
			limit = { $BIRTHPLACE$ = { geographical_region = world_westeros_the_vale } }
			custom_description = {
				text = agot_gain_surname_stone_effect
				object = this
				make_trait_inactive = surname_stone
			}
		}
		else_if = {
			limit = { $BIRTHPLACE$ = { geographical_region = world_westeros_the_westerlands } }
			custom_description = {
				text = agot_gain_surname_hill_effect
				object = this
				make_trait_inactive = surname_hill
			}
		}
		else_if = {
			limit = { $BIRTHPLACE$ = { geographical_region = world_westeros_the_crownlands } }
			custom_description = {
				text = agot_gain_surname_waters_effect
				object = this
				make_trait_inactive = surname_waters
			}
		}
	}
	else_if = {
		limit = {
			faith = {
				NOT = { has_doctrine_parameter = bastards_none }
			}
			OR = {
				has_inactive_trait = surname_flowers
				has_inactive_trait = surname_hill
				has_inactive_trait = surname_pyke
				has_inactive_trait = surname_rivers
				has_inactive_trait = surname_sand
				has_inactive_trait = surname_snow
				has_inactive_trait = surname_stone
				has_inactive_trait = surname_storm
				has_inactive_trait = surname_waters
			}
			has_trait = bastard
		}
		hidden_effect = { agot_remove_bastard_nickname_effect = yes }
		if = {
			limit = { $BIRTHPLACE$ = { geographical_region = world_westeros_dorne } }
			custom_description = {
				text = agot_gain_surname_sand_effect
				object = this
				make_trait_inactive = surname_sand
			}
		}
		else_if = {
			limit = { $BIRTHPLACE$ = { geographical_region = world_westeros_the_iron_islands } }
			custom_description = {
				text = agot_gain_surname_pyke_effect
				object = this
				make_trait_inactive = surname_pyke
			}
		}
		else_if = {
			limit = { $BIRTHPLACE$ = { geographical_region = world_westeros_the_north } }
			custom_description = {
				text = agot_gain_surname_snow_effect
				object = this
				make_trait_inactive = surname_snow
			}
		}
		else_if = {
			limit = { $BIRTHPLACE$ = { geographical_region = world_westeros_the_reach } }
			custom_description = {
				text = agot_gain_surname_flowers_effect
				object = this
				make_trait_inactive = surname_flowers
			}
		}
		else_if = {
			limit = { $BIRTHPLACE$ = { geographical_region = world_westeros_the_riverlands } }
			custom_description = {
				text = agot_gain_surname_rivers_effect
				object = this
				make_trait_inactive = surname_rivers
			}
		}
		else_if = {
			limit = { $BIRTHPLACE$ = { geographical_region = world_westeros_the_stormlands } }
			custom_description = {
				text = agot_gain_surname_storm_effect
				object = this
				make_trait_inactive = surname_storm
			}
		}
		else_if = {
			limit = { $BIRTHPLACE$ = { geographical_region = world_westeros_the_vale } }
			custom_description = {
				text = agot_gain_surname_stone_effect
				object = this
				make_trait_inactive = surname_stone
			}
		}
		else_if = {
			limit = { $BIRTHPLACE$ = { geographical_region = world_westeros_the_westerlands } }
			custom_description = {
				text = agot_gain_surname_hill_effect
				object = this
				make_trait_inactive = surname_hill
			}
		}
		else_if = {
			limit = { $BIRTHPLACE$ = { geographical_region = world_westeros_the_crownlands } }
			custom_description = {
				text = agot_gain_surname_waters_effect
				object = this
				make_trait_inactive = surname_waters
			}
		}
	}
}

agot_add_custom_bastard_nickname_effect = {
	if = {
		limit = {
			NOR = {
				has_inactive_trait = surname_flowers
				has_inactive_trait = surname_hill
				has_inactive_trait = surname_pyke
				has_inactive_trait = surname_rivers
				has_inactive_trait = surname_sand
				has_inactive_trait = surname_snow
				has_inactive_trait = surname_stone
				has_inactive_trait = surname_storm
				has_inactive_trait = surname_waters
			}
		}
		if = {
			limit = { location = { geographical_region = world_westeros_dorne } }
			make_trait_inactive = surname_sand
		}
		else_if = {
			limit = { location = { geographical_region = world_westeros_the_iron_islands } }
			make_trait_inactive = surname_pyke
		}
		else_if = {
			limit = { location = { geographical_region = world_westeros_the_north } }
			make_trait_inactive = surname_snow
		}
		else_if = {
			limit = { location = { geographical_region = world_westeros_the_reach } }
			make_trait_inactive = surname_flowers
		}
		else_if = {
			limit = { location = { geographical_region = world_westeros_the_riverlands } }
			make_trait_inactive = surname_rivers
		}
		else_if = {
			limit = { location = { geographical_region = world_westeros_the_stormlands } }
			make_trait_inactive = surname_storm
		}
		else_if = {
			limit = { location = { geographical_region = world_westeros_the_vale } }
			make_trait_inactive = surname_stone
		}
		else_if = {
			limit = { location = { geographical_region = world_westeros_the_westerlands } }
			make_trait_inactive = surname_hill
		}
		else_if = {
			limit = { location = { geographical_region = world_westeros_the_crownlands } }
			make_trait_inactive = surname_waters
		}
		else = { #fallback for weirdness
			make_trait_inactive = surname_waters
		}
	}
}

agot_remove_bastard_nickname_effect = {
	if = {
		limit = { has_inactive_trait = surname_sand }
		custom_description = {
			text = agot_lose_surname_sand_effect
			object = this
			make_trait_active = surname_sand
			remove_trait = surname_sand
		}
	}
	if = {
		limit = { has_inactive_trait = surname_pyke }
		custom_description = {
			text = agot_pyke_surname_pyke_effect
			object = this
			make_trait_active = surname_pyke
			remove_trait = surname_pyke
		}
	}
	if = {
		limit = { has_inactive_trait = surname_snow }
		custom_description = {
			text = agot_lose_surname_snow_effect
			object = this
			make_trait_active = surname_snow
			remove_trait = surname_snow
		}
	}
	if = {
		limit = { has_inactive_trait = surname_flowers }
		custom_description = {
			text = agot_lose_surname_flowers_effect
			object = this
			make_trait_active = surname_flowers
			remove_trait = surname_flowers
		}
	}
	if = {
		limit = { has_inactive_trait = surname_rivers }
		custom_description = {
			text = agot_lose_surname_rivers_effect
			object = this
			make_trait_active = surname_rivers
			remove_trait = surname_rivers
		}
	}
	if = {
		limit = { has_inactive_trait = surname_storm }
		custom_description = {
			text = agot_lose_surname_storm_effect
			object = this
			make_trait_active = surname_storm
			remove_trait = surname_storm
		}
	}
	if = {
		limit = { has_inactive_trait = surname_stone }
		custom_description = {
			text = agot_lose_surname_stone_effect
			object = this
			make_trait_active = surname_stone
			remove_trait = surname_stone
		}
	}
	if = {
		limit = { has_inactive_trait = surname_hill }
		custom_description = {
			text = agot_lose_surname_hill_effect
			object = this
			make_trait_active = surname_hill
			remove_trait = surname_hill
		}
	}
	if = {
		limit = { has_inactive_trait = surname_waters }
		custom_description = {
			text = agot_lose_surname_waters_effect
			object = this
			make_trait_active = surname_waters
			remove_trait = surname_waters
		}
	}

	# For legitimate descendants who have the bastard surname
	every_child = {
		limit = {
			NOR = {
				has_trait = bastard
				has_trait = bastard_founder
			}
			OR = {
				has_inactive_trait = surname_flowers
				has_inactive_trait = surname_sand
				has_inactive_trait = surname_stone
				has_inactive_trait = surname_rivers
				has_inactive_trait = surname_snow
				has_inactive_trait = surname_pyke
				has_inactive_trait = surname_storm
				has_inactive_trait = surname_hill
				has_inactive_trait = surname_waters
			}
		}
		agot_remove_bastard_nickname_effect = yes
	}
}

agot_create_bastard_cadet_effect = {
	save_scope_as = bastard_branch_creator
	house = { save_scope_as = former_house }
	create_cadet_branch = { } # Create the Cadet subhouse
	house = {
		save_scope_as = new_house
		if = {
			limit = {
				scope:former_house = { has_house_modifier = dragonrider_house_modifier }
			}
			add_house_modifier = dragonrider_house_modifier
		}
		set_variable = { name = bastard_house_of value = scope:former_house }
		#COA
		if = {
			limit = { prev = { has_character_flag = has_personal_coa } }
			set_coa = prev.var:my_personal_coa.house
		}
		else = {
			generate_coa = bastards
		}
	}
	trigger_event = agot_dynastic_stability.1002
}

agot_legitimize_bastard_effect = {
	$BASTARD$ = {
		save_scope_as = bastard
	}
	$LEGITIMIZER$ = {
		save_scope_as = actor
	}
	scope:bastard = {
		remove_trait = bastard
		add_trait = legitimized_bastard

		add_opinion = {
			target = scope:actor
			modifier = legitimized_me_opinion
		}

		agot_remove_bastard_nickname_effect = yes

		if = {
			limit = {
				scope:actor = {
					can_add_hook = {
						type = favor_hook
						target = scope:bastard
					}
				}
			}
			scope:actor = {
				add_hook = {
					type = favor_hook
					target = scope:bastard
				}
			}
		}

		every_child = {
			limit = { is_lowborn = yes }
			set_house = prev.house
			if = {
				limit = {
					NOT = { has_trait = bastard }
				}
				every_child = {
					limit = { is_lowborn = yes }
					set_house = prev.house
					if = {
						limit = {
							NOT = { has_trait = bastard }
						}
						every_child = {
							limit = { is_lowborn = yes }
							set_house = prev.house
						}
					}
				}
			}
		}
	}
}

agot_crown_bastard_nickname_effect = {
	if = {
		limit = { has_inactive_trait = surname_sand }
		hidden_effect = {
			make_trait_active = surname_sand
			remove_trait = surname_sand
		}
		give_nickname = nick_agot_sandcrowned
	}
	else_if = {
		limit = { has_inactive_trait = surname_pyke }
		hidden_effect = {
			make_trait_active = surname_pyke
			remove_trait = surname_pyke
		}
		give_nickname = nick_agot_pykecrowned
	}
	else_if = {
		limit = { has_inactive_trait = surname_snow }
		hidden_effect = {
			make_trait_active = surname_snow
			remove_trait = surname_snow
		}
		give_nickname = nick_agot_snowcrowned
	}
	else_if = {
		limit = { has_inactive_trait = surname_flowers }
		hidden_effect = {
			make_trait_active = surname_flowers
			remove_trait = surname_flowers
		}
		give_nickname = nick_agot_flowercrowned
	}
	else_if = {
		limit = { has_inactive_trait = surname_rivers }
		hidden_effect = {
			make_trait_active = surname_rivers
			remove_trait = surname_rivers
		}
		give_nickname = nick_agot_rivercrowned
	}
	else_if = {
		limit = { has_inactive_trait = surname_storm }
		hidden_effect = {
			make_trait_active = surname_storm
			remove_trait = surname_storm
		}
		give_nickname = nick_agot_stormcrowned
	}
	else_if = {
		limit = { has_inactive_trait = surname_stone }
		hidden_effect = {
			make_trait_active = surname_stone
			remove_trait = surname_stone
		}
		give_nickname = nick_agot_stonecrowned
	}
	else_if = {
		limit = { has_inactive_trait = surname_hill }
		hidden_effect = {
			make_trait_active = surname_hill
			remove_trait = surname_hill
		}
		give_nickname = nick_agot_hillcrowned
	}
	else_if = {
		limit = { has_inactive_trait = surname_waters }
		hidden_effect = {
			make_trait_active = surname_waters
			remove_trait = surname_waters
		}
		give_nickname = nick_agot_watercrowned
	}
}

agot_children_of_bastard_surname_effect = {
	if = {
		limit = {
			NOT = { faith = { has_doctrine_parameter = bastards_none } }
			NOT = {
				has_trait = bastard
			}
			exists = scope:father
		}
		if = {
			limit = {
				scope:father = {
					OR = {
						AND = {
							is_spouse_of = scope:mother
							matrilinear_marriage = yes
						}
						is_concubine_of = scope:mother
					}
				}
				mother = {
					NOR = {
						has_trait = legitimized_bastard
						has_trait = bastard_founder
					}
					OR = {
						has_inactive_trait = surname_flowers
						has_inactive_trait = surname_sand
						has_inactive_trait = surname_stone
						has_inactive_trait = surname_rivers
						has_inactive_trait = surname_snow
						has_inactive_trait = surname_pyke
						has_inactive_trait = surname_storm
						has_inactive_trait = surname_hill
						has_inactive_trait = surname_waters
					}
				}
			}
			if = {
				limit = {
					mother = {
						has_inactive_trait = surname_flowers
					}
				}
				make_trait_inactive = surname_flowers
			}
			if = {
				limit = {
					mother = {
						has_inactive_trait = surname_sand
					}
				}
				make_trait_inactive = surname_sand
			}
			if = {
				limit = {
					mother = {
						has_inactive_trait = surname_stone
					}
				}
				make_trait_inactive = surname_stone
			}
			if = {
				limit = {
					mother = {
						has_inactive_trait = surname_storm
					}
				}
				make_trait_inactive = surname_storm
			}
			if = {
				limit = {
					mother = {
						has_inactive_trait = surname_snow
					}
				}
				make_trait_inactive = surname_snow
			}
			if = {
				limit = {
					mother = {
						has_inactive_trait = surname_hill
					}
				}
				make_trait_inactive = surname_hill
			}
			if = {
				limit = {
					mother = {
						has_inactive_trait = surname_pyke
					}
				}
				make_trait_inactive = surname_pyke
			}
			if = {
				limit = {
					mother = {
						has_inactive_trait = surname_rivers
					}
				}
				make_trait_inactive = surname_rivers
			}
			if = {
				limit = {
					mother = {
						has_inactive_trait = surname_waters
					}
				}
				make_trait_inactive = surname_waters
			}
		}
		else_if = {
			limit = {
				mother = {
					OR = {
						AND = {
							is_spouse_of = scope:father
							matrilinear_marriage = no
						}
						is_concubine_of = scope:father
					}
				}
				father = {
					NOR = {
						has_trait = legitimized_bastard
						has_trait = bastard_founder
					}
					OR = {
						has_inactive_trait = surname_flowers
						has_inactive_trait = surname_sand
						has_inactive_trait = surname_stone
						has_inactive_trait = surname_rivers
						has_inactive_trait = surname_snow
						has_inactive_trait = surname_pyke
						has_inactive_trait = surname_storm
						has_inactive_trait = surname_hill
						has_inactive_trait = surname_waters
					}
				}
			}
			if = {
				limit = {
					father = {
						has_inactive_trait = surname_flowers
					}
				}
				make_trait_inactive = surname_flowers
			}
			if = {
				limit = {
					father = {
						has_inactive_trait = surname_sand
					}
				}
				make_trait_inactive = surname_sand
			}
			if = {
				limit = {
					father = {
						has_inactive_trait = surname_stone
					}
				}
				make_trait_inactive = surname_stone
			}
			if = {
				limit = {
					father = {
						has_inactive_trait = surname_storm
					}
				}
				make_trait_inactive = surname_storm
			}
			if = {
				limit = {
					father = {
						has_inactive_trait = surname_snow
					}
				}
				make_trait_inactive = surname_snow
			}
			if = {
				limit = {
					father = {
						has_inactive_trait = surname_hill
					}
				}
				make_trait_inactive = surname_hill
			}
			if = {
				limit = {
					father = {
						has_inactive_trait = surname_pyke
					}
				}
				make_trait_inactive = surname_pyke
			}
			if = {
				limit = {
					father = {
						has_inactive_trait = surname_rivers
					}
				}
				make_trait_inactive = surname_rivers
			}
			if = {
				limit = {
					father = {
						has_inactive_trait = surname_waters
					}
				}
				make_trait_inactive = surname_waters
			}
		}
	}
}

agot_update_noble_bastard_house_and_descendants = {
	$OLD_HOUSE$ = { save_scope_as = old_house }
	$NEW_HOUSE$ = { save_scope_as = new_house }
	agot_update_common_bastard_house_and_descendants = { NEW_HOUSE = scope:new_house }
}

agot_update_common_bastard_house_and_descendants = {
	$NEW_HOUSE$ = { save_scope_as = new_house }
	save_scope_as = og_bastard

	every_child = {
		even_if_dead = yes
		limit = {
			OR = {
				AND = {
					exists = scope:old_house
					house ?= scope:old_house
				}
				is_lowborn = yes
			}
		}
		scope:og_bastard = {
			add_to_variable_list = {
				name = house_derived_from_og_bastard
				target = prev
			}
		}
		if = {
			limit = {
				prev = { is_male = yes }
			}
			add_character_flag = {
				flag = house_from_dad
				days = 1
			}
		}
		else = {
			add_character_flag = {
				flag = house_from_mom
				days = 1
			}
		}
		every_child = {
			even_if_dead = yes
			limit = {
				OR = {
					AND = {
						exists = scope:old_house
						house ?= scope:old_house
					}
					is_lowborn = yes
				}
			}
			scope:og_bastard = {
				add_to_variable_list = {
					name = house_derived_from_og_bastard
					target = prev
				}
			}
			if = {
				limit = {
					prev = { is_male = yes }
				}
				add_character_flag = {
					flag = house_from_dad
					days = 1
				}
			}
			else = {
				add_character_flag = {
					flag = house_from_mom
					days = 1
				}
			}
			every_child = {
				even_if_dead = yes
				limit = {
					OR = {
						AND = {
							exists = scope:old_house
							house ?= scope:old_house
						}
						is_lowborn = yes
					}
				}
				scope:og_bastard = {
					add_to_variable_list = {
						name = house_derived_from_og_bastard
						target = prev
					}
				}
				if = {
					limit = {
						prev = { is_male = yes }
					}
					add_character_flag = {
						flag = house_from_dad
						days = 1
					}
				}
				else = {
					add_character_flag = {
						flag = house_from_mom
						days = 1
					}
				}
			}
		}
	}

	set_house = scope:new_house
	trigger_event = agot_coa_events.0001

	every_child = {
		even_if_dead = yes
		limit = {
			scope:og_bastard = {
				is_target_in_variable_list = {
					name = house_derived_from_og_bastard
					target = prev
				}
			}
		}
		agot_update_bastard_descendant_effect = yes
		every_child = {
			even_if_dead = yes
			limit = {
				scope:og_bastard = {
					is_target_in_variable_list = {
						name = house_derived_from_og_bastard
						target = prev
					}
				}
			}
			agot_update_bastard_descendant_effect = yes
			every_child = {
				even_if_dead = yes
				limit = {
					scope:og_bastard = {
						is_target_in_variable_list = {
							name = house_derived_from_og_bastard
							target = prev
						}
					}
				}
				agot_update_bastard_descendant_effect = yes
			}
		}
	}
}

agot_update_bastard_descendant_effect = {
	if = {
		limit = {
			trigger_if = {
				limit = { exists = mother }
				mother = {
					OR = {
						has_trait = bastard
						is_lowborn = yes
					}
				}
			}
			trigger_if = {
				limit = { exists = father }
				father = {
					OR = {
						has_trait = bastard
						is_lowborn = yes
					}
				}
			}
		}
		set_to_lowborn = yes
	}
	else_if = {
		limit = {
			exists = father
			exists = father.house
			mother ?= {
				OR = {
					has_trait = bastard
					is_lowborn = yes
				}
			}
		}
		set_house = father.house
	}
	else_if = {
		limit = {
			exists = mother
			exists = mother.house
			father ?= {
				OR = {
					has_trait = bastard
					is_lowborn = yes
				}
			}
		}
		set_house = mother.house
	}
	else_if = {
		limit = {
			has_character_flag = house_from_dad
		}
		set_house = father.house
	}
	else_if = {
		limit = {
			has_character_flag = house_from_mom
		}
		set_house = mother.house
	}
	trigger_event = agot_coa_events.0001
}
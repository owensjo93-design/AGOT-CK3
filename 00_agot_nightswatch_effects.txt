agot_add_to_nightswatch_effect = {
	agot_debug_log_effect = { MSG = agot_debug_msg_agot_add_to_nightswatch_effect }

	#We need to save this scope for the loc
	save_scope_as = nightswatch_candidate
	consume_imprisonment_reasons = scope:nightswatch_candidate
	if = {
		limit = { has_character_flag = blocked_from_leaving }
		remove_character_flag = blocked_from_leaving
	}
	if = {
		limit = {
			has_variable = current_dragon
		}
		var:current_dragon = { save_scope_as = dragon }
		agot_untame_dragon = {
			OWNER = scope:nightswatch_candidate
			DRAGON = scope:dragon
		}
	}
	else_if = {
		limit = {
			any_relation = { type = agot_dragon }
		}
		every_relation = {
			type = agot_dragon
			save_scope_as = dragon
			agot_unbond_dragon = {
				OWNER = scope:nightswatch_candidate
				DRAGON = scope:dragon
			}
		}
	}
	if = {
		limit = {
			any_scheme = {
				scheme_type = bond_with_dragon_scheme
			}
		}
		every_scheme = {
			limit = { scheme_type = bond_with_dragon_scheme }
			end_scheme = yes
		}
	}
	if = {
		limit = {
			has_trait = kingsguard
		}
		agot_remove_kingsguard_effect = { KINGSGUARD = scope:nightswatch_candidate }
	}
	if = {
		limit = {
			has_trait = order_member
		}
		remove_trait = order_member
	}
	if = {
		limit = {
			has_trait = devoted
		}
		remove_trait = devoted
	}
	if = {
		limit = { is_imprisoned = yes }

		release_from_prison = yes
	}
	if = {
		limit = { faith = faith:old_gods_wnw }
		add_piety_level = 1
	}

	loan_inheritance = yes

	if = {
		limit = {
			has_variable = IB_Shares
			var:IB_Shares > 0
		}
		if = {
			limit = {
				exists = primary_heir
			}

			save_scope_as = parent_shareholder

			primary_heir = {
				if = {
					limit = {
						has_variable = IB_Shares
					}
					change_variable = {
						name = IB_Shares
						add = scope:parent_shareholder.var:IB_Shares
					}
				}
				else = {
					set_variable = {
						name = IB_Shares
						value = scope:parent_shareholder.var:IB_Shares
					}
					add_to_global_variable_list = {
						name = IB_Shareholder
						target = this
					}
					set_variable = {
						name = BankName
						value = global_var:IB_location
					}
				}
			}
			remove_list_global_variable = {
				name = IB_Shareholder
				target = this
			}
			set_variable = {
				name = IB_Shares
				value = 0
			}
		}
	}
	else_if = {
		limit = {
			has_variable = bank1_Shares
			var:bank1_Shares > 0
		}
		if = {
			limit = {
				exists = primary_heir
			}

			save_scope_as = parent_shareholder

			primary_heir = {
				if = {
					limit = {
						has_variable = bank1_Shares
					}
					change_variable = {
						name = bank1_Shares
						add = scope:parent_shareholder.var:bank1_Shares
					}
				}
				else = {
					set_variable = {
						name = bank1_Shares
						value = scope:parent_shareholder.var:bank1_Shares
					}
					add_to_global_variable_list = {
						name = bank1_Shareholder
						target = this
					}
					set_variable = {
						name = BankName
						value = global_var:bank1_location
					}
				}
			}
			remove_list_global_variable = {
				name = bank1_Shareholder
				target = this
			}
			set_variable = {
				name = bank1_Shares
				value = 0
			}
		}
	}
	else_if = {
		limit = {
			has_variable = bank2_Shares
			var:bank2_Shares > 0
		}
		if = {
			limit = {
				exists = primary_heir
			}

			save_scope_as = parent_shareholder

			primary_heir = {
				if = {
					limit = {
						has_variable = bank2_Shares
					}
					change_variable = {
						name = bank2_Shares
						add = scope:parent_shareholder.var:bank2_Shares
					}
				}
				else = {
					set_variable = {
						name = bank2_Shares
						value = scope:parent_shareholder.var:bank2_Shares
					}
					add_to_global_variable_list = {
						name = bank2_Shareholder
						target = this
					}
					set_variable = {
						name = BankName
						value = global_var:bank2_location
					}
				}
			}
			remove_list_global_variable = {
				name = bank2_Shareholder
				target = this
			}
			set_variable = {
				name = bank2_Shares
				value = 0
			}
		}
	}
	else_if = {
		limit = {
			has_variable = bank3_Shares
			var:bank3_Shares > 0
		}
		if = {
			limit = {
				exists = primary_heir
			}

			save_scope_as = parent_shareholder

			primary_heir = {
				if = {
					limit = {
						has_variable = bank3_Shares
					}
					change_variable = {
						name = bank3_Shares
						add = scope:parent_shareholder.var:bank3_Shares
					}
				}
				else = {
					set_variable = {
						name = bank3_Shares
						value = scope:parent_shareholder.var:bank3_Shares
					}
					add_to_global_variable_list = {
						name = bank3_Shareholder
						target = this
					}
					set_variable = {
						name = BankName
						value = global_var:bank3_location
					}
				}
			}
			remove_list_global_variable = {
				name = bank3_Shareholder
				target = this
			}
			set_variable = {
				name = bank3_Shares
				value = 0
			}
		}
	}

	hidden_effect = { #messy tooltip
		if = {
			limit = {
				exists = house
				is_house_head = yes
				house = {
					any_house_member = {
						count > 1
					}
				}
			}
			if = {
				limit = {
					exists = primary_heir
					house = primary_heir.house
				}
				primary_heir = { save_scope_as = new_house_head }
				house = { set_house_head = scope:new_house_head }
			}
			else_if = {
				limit = {
					house = {
						any_house_member = {
							is_ruler = yes
							NOT = { this = scope:nightswatch_candidate }
						}
					}
				}
				house = {
					ordered_house_member = {
						limit = {
							is_ruler = yes
							NOT = { this = scope:nightswatch_candidate }
						}
						order_by = primary_title.tier
						save_scope_as = new_house_head
					}
				}
				house = { set_house_head = scope:new_house_head }
			}
			else = {
				house = {
					random_house_member = {
						limit = {
							NOT = { this = scope:nightswatch_candidate }
						}
						save_scope_as = new_house_head
					}
				}
				house = { set_house_head = scope:new_house_head }
			}
		}
	}
	if = {
		limit = { has_trait = high_septon }
		remove_trait = high_septon
	}
	if = {
		limit = { has_inactive_trait = grandmaester }
		hidden_effect = {
			agot_expel_appropriate_maester_effect = yes
		}
	}
	if = {
		limit = {
			is_ruler = yes
			NOR = {
				government_has_flag = government_is_nw
				any_liege_or_above = {
					government_has_flag = government_is_nw
				}
			}
		}
		depose = yes
	}
	if = {
		limit = {
			is_married = yes
		}
		every_spouse = {
			divorce = scope:nightswatch_candidate
		}
	}
	if = {
		limit = {
			exists = betrothed
		}
		if = {
			limit = {
				scope:banish ?= yes
			}
			hidden_effect = {
				if = {
					limit = {
						has_been_promised_grand_wedding = yes
					}
					break_grand_wedding_betrothal_effect = yes
				}
				else = {
					break_betrothal = betrothed
				}
			}
			show_as_tooltip = {
				break_betrothal = betrothed
			}
		}
		else = {
			if = {
				limit = {
					has_been_promised_grand_wedding = yes
				}
				break_grand_wedding_betrothal_effect = yes
			}
			else = {
				break_betrothal = betrothed
			}
		}
	}
	if = {
		limit = {
			any_relation = {
				type = guardian
				exists = this
			}
		}
		every_relation = {
			type = guardian
			scope:nightswatch_candidate = {
				remove_relation_guardian = prev
			}
		}
	}
	if = {
		limit = {
			any_relation = {
				type = ward
				exists = this
			}
		}
		every_relation = {
			type = ward
			remove_relation_guardian = prev
		}
	}
	if = {
		limit = {
			is_concubine = yes
		}
		this.concubinist = {
			remove_concubine = scope:nightswatch_candidate
		}
	}
	if = {
		limit = {
			number_of_concubines > 0
		}
		every_concubine = {
			scope:nightswatch_candidate = {
				remove_concubine = prev
			}
		}
	}
	if = {
		limit = {
			has_trait = refusing_marriage
		}
		remove_trait = refusing_marriage
	}
	if = {
		limit = {
			has_character_modifier = training_for_kingsguard
		}
		remove_character_modifier = training_for_kingsguard
	}
	if = {
		limit = {
			is_human = yes
		}
		add_trait = nightswatch
		create_character_memory = {
			type = agot_joined_nightswatch
			participants = {
				commander = title:k_the_wall.holder
			}
		}
	}
	every_claim = {
		prev = {
			remove_claim = prev
		}
	}
}

agot_send_to_nightswatch_effect = {
	$NIGHTSWATCH_CANDIDATE$ = {
		agot_add_to_nightswatch_effect = yes
		every_relation = {
			type = rival
			trigger_event = agot_nights_watch.0027
		}
	}
	if = {
		limit = {
			OR = {
				NOT = { government_has_flag = government_is_nw }
				$NIGHTSWATCH_CANDIDATE$ = $ACTOR$
			}
		}
		title:k_the_wall.holder = {
			trigger_event = agot_nights_watch.0100
			add_courtier = $NIGHTSWATCH_CANDIDATE$

			add_opinion = {
				target = $ACTOR$
				modifier = grateful_opinion
				opinion = 30
			}
		}
	}
}

agot_random_nightswatch_death_effect = {
	agot_debug_log_effect = { MSG = agot_debug_msg_agot_random_nightswatch_death_effect }

	random_list = {
		40 = {
			trigger = {
				has_trait_xp = {
					trait = nightswatch
					value < 100
				}
			}
			death = { death_reason = death_training_accident }
		}
		20 = {
			trigger = {
				has_trait = lifestyle_nw_builder
			}
			death = { death_reason = death_crushed_by_boulder }
		}
		20 = {
			trigger = {
				has_trait = lifestyle_nw_builder
			}
			death = { death_reason = death_equipment }
		}
		20 = {
			trigger = {
				has_trait = lifestyle_nw_ranger
			}
			death = { death_reason = death_wild_animal }
		}
		20 = {
			trigger = {
				has_trait = lifestyle_nw_ranger
			}
			death = { death_reason = death_disappeared_on_ranging }
		}
		20 = {
			trigger = {
				has_trait = lifestyle_nw_ranger
			}
			death = { death_reason = death_lost_in_the_forest }
		}
		20 = {
			trigger = {
				OR = {
					has_trait = drunkard
					has_trait = depressed
					has_trait = depressed_genetic
				}
			}
			death = { death_reason = death_jumped_off_the_wall }
		}
		40 = {
			death = { death_reason = death_froze_to_death }
		}
		40 = {
			death = { death_reason = death_lost_in_snowstorm }
		}
		5 = {
			death = { death_reason = death_fell_off_the_wall }
		}
		40 = {
			death = { death_reason = death_vanished }
		}
		1 = {
			trigger = { has_trait = lunatic }
			death = { death_reason = death_grabbed_by_grumkins }
		}
	}
}

agot_nightswatch_ruler_on_start_effect = {
	if = {
		limit = {
			has_trait = nightswatch_historical
		}
		agot_remove_nightswatch_traits_effect = yes
		if = {
			limit = {
				agot_valid_potential_nw_member = yes
			}
			add_trait = nightswatch
			add_trait_xp = {
				trait = nightswatch
				value = 100
			}
		}
	}

	if = {
		limit = { agot_valid_potential_nw_member = no }
		agot_remove_nightswatch_traits_effect = yes
		depose = yes
		move_to_pool_at = title:d_winterfell.holder.capital_province
	}
	else_if = {
		limit = {
			NOT = { has_trait = nightswatch }
		}
		agot_add_to_nightswatch_effect = yes
	}

	if = {
		limit = {
			has_trait = nightswatch
			has_trait_xp = {
				trait = nightswatch
				value < 100
			}
			age > 15
		}
		trigger_event = agot_nightswatch_maintenance.0101
	}

	if = {
		limit = {
			has_trait = nightswatch
			agot_is_landless_nw_character = no
			primary_title.title_province = {
				has_holding_type = castle_holding
			}
			OR = {
				NOT = { government_has_flag = government_is_nw }
				NOT = { has_realm_law = nights_watch_realm_succession_law }
			}
		}
		if = {
			limit = {
				NOT = { government_has_flag = government_is_nw }
			}
			change_government = nights_watch_government
		}
		if = {
			limit = {
				NOT = { has_realm_law = nights_watch_realm_succession_law }
			}
			add_realm_law_skip_effects = nights_watch_realm_succession_law
		}
	}
}

agot_nightswatch_courtier_on_start_effect = {
	if = {
		limit = {
			has_trait = nightswatch_historical
		}
		agot_remove_nightswatch_traits_effect = yes
		if = {
			limit = {
				agot_valid_potential_nw_member = yes
			}
			add_trait = nightswatch
			add_trait_xp = {
				trait = nightswatch
				value = 100
			}
		}
	}

	if = {
		limit = { agot_valid_potential_nw_member = no }
		agot_remove_nightswatch_traits_effect = yes
		move_to_pool_at = title:d_winterfell.holder.capital_province
	}
	else_if = {
		limit = {
			NOT = { has_trait = nightswatch }
		}
		agot_add_to_nightswatch_effect = yes
	}

	if = {
		limit = {
			has_trait = nightswatch
			has_trait_xp = {
				trait = nightswatch
				value < 100
			}
			age > 15
		}
		trigger_event = agot_nightswatch_maintenance.0101
	}
}

agot_remove_nightswatch_traits_effect = {
	if = {
		limit = { has_trait = nightswatch_historical }
		remove_trait = nightswatch_historical
	}
	if = {
		limit = { has_trait = nightswatch_temp }
		remove_trait = nightswatch_temp
	}
	if = {
		limit = { has_trait = nightswatch }
		remove_trait = nightswatch
	}
	if = {
		limit = { has_trait = nightswatch }
		remove_trait = nightswatch
	}
	if = {
		limit = { has_trait = lifestyle_nw_ranger }
		remove_trait = lifestyle_nw_ranger
	}
	if = {
		limit = { has_trait = lifestyle_nw_builder }
		remove_trait = lifestyle_nw_builder
	}
	if = {
		limit = { has_trait = lifestyle_nw_steward }
		remove_trait = lifestyle_nw_steward
	}
}

agot_on_eastwatch_court_position_revoked = {
	scope:liege = {
		trigger_event = {
			id = agot_nights_watch.0006
			days = 1
		}
	}
}

agot_on_shadowtower_court_position_revoked = {
	scope:liege = {
		trigger_event = {
			id = agot_nights_watch.0007
			days = 1
		}
	}
}

agot_on_nightfort_court_position_revoked = {
	scope:liege = {
		trigger_event = {
			id = agot_nights_watch.0008
			days = 1
		}
	}
}

agot_on_icemark_court_position_revoked = {
	scope:liege = {
		trigger_event = {
			id = agot_nights_watch.0009
			days = 1
		}
	}
}

agot_on_deep_lake_court_position_revoked = {
	scope:liege = {
		trigger_event = {
			id = agot_nights_watch.0010
			days = 1
		}
	}
}

agot_on_queengate_court_position_revoked = {
	scope:liege = {
		trigger_event = {
			id = agot_nights_watch.0011
			days = 1
		}
	}
}

agot_on_oakenshield_court_position_revoked = {
	scope:liege = {
		trigger_event = {
			id = agot_nights_watch.0012
			days = 1
		}
	}
}

agot_on_woodwatch_court_position_revoked = {
	scope:liege = {
		trigger_event = {
			id = agot_nights_watch.0013
			days = 1
		}
	}
}

agot_on_westwatch_court_position_revoked = {
	scope:liege = {
		trigger_event = {
			id = agot_nights_watch.0014
			days = 1
		}
	}
}

agot_on_sentinel_court_position_revoked = {
	scope:liege = {
		trigger_event = {
			id = agot_nights_watch.0015
			days = 1
		}
	}
}

agot_on_greyguard_court_position_revoked = {
	scope:liege = {
		trigger_event = {
			id = agot_nights_watch.0016
			days = 1
		}
	}
}

agot_on_stonedoor_court_position_revoked = {
	scope:liege = {
		trigger_event = {
			id = agot_nights_watch.0017
			days = 1
		}
	}
}

agot_on_hoarfrost_court_position_revoked = {
	scope:liege = {
		trigger_event = {
			id = agot_nights_watch.0018
			days = 1
		}
	}
}

agot_on_stable_court_position_revoked = {
	scope:liege = {
		trigger_event = {
			id = agot_nights_watch.0019
			days = 1
		}
	}
}

agot_on_rimegate_court_position_revoked = {
	scope:liege = {
		trigger_event = {
			id = agot_nights_watch.0020
			days = 1
		}
	}
}

agot_on_longbarrow_court_position_revoked = {
	scope:liege = {
		trigger_event = {
			id = agot_nights_watch.0021
			days = 1
		}
	}
}

agot_on_torches_court_position_revoked = {
	scope:liege = {
		trigger_event = {
			id = agot_nights_watch.0022
			days = 1
		}
	}
}

agot_on_greenguard_court_position_revoked = {
	scope:liege = {
		trigger_event = {
			id = agot_nights_watch.0023
			days = 1
		}
	}
}
